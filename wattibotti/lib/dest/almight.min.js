/**
 * AlmightJS HTML5 Novel Game Engine v4.0.0
 * http://almight.jp
 * Copyright 2014 EISYS, Inc.
 * Date: 2014-02-20
 */

function int(t){return parseInt(t,10)}function intrandom(t,e){return e=void 0===e?0:e,t>e&&(e=t,t=0),parseInt(Math.random()*(e-t+1)+t,10)}(function(window){window.Almight={version:"4.0.0",lang:["ja"],nowlang:0,resourcePath:"../game/",filePath:null,exec:function(js,global){try{if(!global)return exp=eval(js);$.globalEval(js)}catch(e){return console.error(e.message),console.groupCollapsed("↓↓↓↓↓ Error Code ↓↓↓↓↓"),console.log(js),console.warn((e.stack+"").replace(RegExp(location.origin,"ig"),"~")),console.groupEnd("↓↓↓↓↓ Error Code ↓↓↓↓↓"),!0}},warn:function(t){window.console&&console.warn&&console.warn("AlmightJS warning: "+t)},error:function(){var t=Array.prototype.slice.call(arguments),e=t.shift(),i=this.lang[this.nowlang]||"en"||"ja";throw e in Almight.i18n[i]&&(e=Almight.i18n[i][e],e=e.replace(/\{(\d+)\}/g,function(){return t[arguments[1]]||""})),0===$(".almight-error").length&&($("body").append('<div class="almight-error"><span>'+Almight.i18n[i].onError+"</span></div>"),$(".almight-error a").on("click",function(){$(".almight-error").fadeOut("fast",function(){$(this).remove();try{almight.script.dequeue()}catch(t){}})})),Error(e)}},Almight.i18n={ja:{onError:'エラーが発生しました<br/>ゲームを再起動しても直らない場合はお問い合せください<br/><a href="#">強制的に続行する</a>',containerNotFound:"コンテナは1つだけ指定してください",tagNotFound:"[{0}] タグが見つかりません"}},Almight.Platform={touch:function(){return"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch?!0:!1}(),mobile:function(){return navigator.userAgent.match(/iphone|ipod|ipad|android/i)?!0:!1}(),viewer:function(){return"object"==typeof Titanium?!0:!1}(),webAudio:function(){return"undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext?!0:!1}()},Almight.Util={getPath:function(t){if(void 0===t)return"";t=(t+"").toLowerCase();var e=t.replace(/\.([a-zA-Z0-9\_\-]+)$/,""),i=t.match(/\.([a-zA-Z0-9\_\-]+)$/);return 0===t.indexOf(Almight.resourcePath)?t:-1!==t.indexOf("/")?Almight.resourcePath+t:null!==Almight.filePath&&t in Almight.filePath?Almight.resourcePath+Almight.filePath[t]:null!==Almight.filePath&&e in Almight.filePath?Almight.resourcePath+Almight.filePath[e]:null!==Almight.filePath||null===i?Almight.resourcePath+t:Almight.resourcePath+i[1]+"/"+t},rgba:function(t,e){return void 0===t?"":(void 0===e&&(e=1),/^0x/.test(t)&&(t=t.replace(/^0x/,""),t=t.split("")),/^#/.test(t)&&(t=t.replace(/^#/,""),t=t.split("")),t=3===t.length?{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16)}:{r:parseInt(t[0]+t[1],16),g:parseInt(t[2]+t[3],16),b:parseInt(t[4]+t[5],16)},"rgba("+t.r+", "+t.g+", "+t.b+", "+e+")")}}})(window),function(){function t(){i=window.innerHeight,document.body.style.minHeight="3000px",n=0,setTimeout(function(){e(),a&&clearInterval(a),a=setInterval(e,s)},100)}function e(){window.scrollTo(0,1),setTimeout(function(){var t=document.body.scrollTop;(t>0||window.innerHeight>i)&&(document.body.style.minHeight=window.innerHeight+"px",clearInterval(a),a=null)},0)}var i,s=500,a=0,n=0;window.addEventListener&&navigator.userAgent.match(/iphone|ipod|android/i)&&(window.addEventListener("load",t),window.addEventListener("orientationchange",t))}(),function(t){"use strict";var e="outerHTML";t.fn[e]||(t.fn[e]=function(e){var i,s=t(this);return 0>=s.length?!1:(e?i=s.replaceWith(e):s[0].outerHTML!==void 0?i=s[0].outerHTML:(i=s.wrap("<div>").parent().html(),s.unwrap()),i)})}(jQuery),function(){"use strict";Almight.Plugin=function(){return this.initialize.apply(this,arguments)},Almight.Plugin.prototype={initialize:function(t){var e=this,i=$.Deferred();return $.ajax({url:"plugin/"+t,type:"GET",dataType:"text"}).done(function(s){/\.js$/.test(t)?($.globalEval(s),i.resolve()):($.each($.parseHTML(s,!0),function(){var t=[];if($(this).is('[data-append="yes"]')?t=$(this):0!==$(this).find('[data-append="yes"]:first').length&&(t=$(this).find('[data-append="yes"]:first')),1===t.length){var i=t.prop("tagName").toLowerCase();switch(i){case"style":$(e).queue("addStyle",function(){$("head").append(t),$(e).dequeue("addStyle")});break;case"script":$(e).queue("addScript",function(){$.globalEval(t.text()),$(e).dequeue("addScript")});break;default:$(e).queue("addDom",function(){var i;i=$(t).attr("data-selector"),Almight.Platform.mobile&&void 0!==$(t).attr("data-mobile-selector")&&(i=$(t).attr("data-mobile-selector")),void 0===i&&(i="body"),$(i).append(t),$(e).dequeue("addDom")})}}}),$(e).dequeue("addStyle").dequeue("addDom").dequeue("addScript"),i.resolve())}).fail(function(t,e,s){i.reject(s)}),i.promise()}}}(),function(){"use strict";Almight.Stage=function(){this.container="",this.width=1136,this.height=640,this.stageWidth=1136,this.stageHeight=640,this.stageTop=0,this.stageLeft=0,this.zoomRatio=1,this.pixelRatio=1,this.stageZoom=!1,this.trans={},this.transElement=null,this.transitioning=!1,this.locate={x:0,y:0},this.element=null,this.backElement=null,this.back={base:null,layers:[],messages:[]},this.fore={base:null,layers:[],messages:[]},this.current=null,this.currentNum=0,this.currentPage="fore",this.canClick=!0,this.clickWaiting=!1,this.textAnimating=!1,this.skipping=!1,this.skipTimer=null,this.autoMode=!1,this.autoDelay=1e3,this.historyOutput=!0,this.historyEnabled=!0,this.initialize.apply(this,arguments)},Almight.Stage.prototype={initialize:function(t,e,i){this.width=e,this.height=i,this.stageWidth=e,this.stageHeight=i,this.container=$("#"+t),1!==this.container.length?Almight.error("containerNotFound"):this.container=this.container[0];var s=document.createElement("canvas"),a=s.getContext("2d"),n=window.devicePixelRatio||1,o=a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1,r=n/o;s=null,a=null,this.pixelRatio=r,this.backElement=$("<div/>").attr({id:t+"-back-stage","class":"almight-back-stage"}).css({width:this.width,height:this.height}).appendTo(this.container)[0],this.element=$("<div/>").attr({id:t+"-stage","class":"almight-stage"}).css({width:this.width,height:this.height}).appendTo(this.container)[0],this.transElement=$("<div/>").attr({id:t+"-trans-stage","class":"almight-trans-stage"}).css({width:this.width,height:this.height}).appendTo(this.container)[0],this._stageEventSetting()},_stageEventSetting:function(){if(Almight.Platform.touch){$([this.element,this.transElement]).on({tap:function(){$(Almight).triggerHandler("stageclick")},touchmove:function(){event.preventDefault()}});var t={swipeDown:function(){$(Almight).one("stageclick",function(){$(almight.stage.element).find(".almight-message-layer").animate({top:"-="+almight.config.height},{duration:"fast",easing:"linear",complete:function(){self.almight.stage.canClick=!0}})}),almight.stage.canClick=!1,$(almight.stage.element).find(".almight-message-layer").animate({top:"+="+almight.config.height},{duration:"fast",easing:"linear"})},threshold:50};$(".almight-stage").swipe(t)}else $([this.element,this.transElement]).on({click:function(){$(Almight).triggerHandler("stageclick")},mousewheel:function(t,e,i,s){return 0>s&&$(Almight).triggerHandler("stageclick"),almight.stage.canClick?!1:void 0}}),$(window).on({keydown:function(t){(13===t.keyCode||32===t.keyCode)&&$(Almight).triggerHandler("stageclick")},mousewheel:function(){return almight.stage.canClick?!1:void 0}})},add:function(t,e,i){return e=void 0===e?"fore":e,t.parent=this,"base"===i?this[e].base=t:"number"==typeof i?this[e].layers[i]=t:/^message[0-9]+$/.test(i)?(i=Number(i.replace("message","")),this[e].messages[i]=t):Almight.error("引数が無効です"),"fore"===e?$(this.element).append(t.element):$(this.backElement).append(t.element),this},remove:function(t,e){t=void 0===t?"fore":t,"base"===e?($(this[t].base.element).remove(),this[t].base.children=null,this[t].base=null):"number"==typeof e?($(this[t].layers[e].element).remove(),this[t].layers[e].children=null,this[t].layers.splice(e,1)):/^message[0-9]+$/.test(e)?(e=Number(e.replace("message","")),$(this[t].messages[e].element).remove(),this[t].messages[e].children=null,this[t].messages.splice(e,1)):Almight.error("引数が無効です")},getLayerFromParams:function(t){void 0===t.layer&&Almight.error("layer属性がありません");var e="back"===t.page?this.back:this.fore;return"base"===t.layer?e.base:"message"===t.layer?this.current:/^message[0-9]+$/.test(t.layer)?e.messages[Number(t.layer.replace("message",""))]:e.layers[Number(t.layer)]},getLayerPageFromParams:function(t,e){void 0===t.layer&&Almight.error("layer属性がありません");var i="back"===e?this.back:this.fore;return"base"===t.layer||void 0===t.layer?i.base:/^message[0-9]+$/.test(t.layer)?i.messages[Number(t.layer.replace("message",""))]:i.layers[Number(t.layer)]},getMessageLayerObjectFromParams:function(t){var e,i=t.page,s=t.layer;return void 0===i&&void 0===s?this.current:(e=void 0===i?this[this.currentPage]:"back"===i?this.back:this.fore,void 0===s||"message"===s?e.messages[this.currentNum]:/^message[0-9]+$/.test(t.layer)?e.messages[Number(t.layer.replace("message",""))]:(Almight.error("layer属性に指定できない値です"),void 0))},setCurrentMessageLayer:function(t){this.currentPage="back"===t.page?"back":"fore",this.currentNum=/^message[0-9]+$/.test(t.layer)?Number(t.layer.replace("message","")):this.currentNum,this.current=this[this.currentPage].messages[this.currentNum]},resizeStage:function(){var t=window.innerWidth?window.innerWidth:$(window).width(),e=window.innerHeight?window.innerHeight:$(window).height(),i=t/this.width,s=e/this.height,a=i>s?s:i;a>1&&(a=1),this.stageZoom!==!1||Almight.Platform.mobile||(a=1),this.stageWidth=~~(a*this.width),this.stageHeight=~~(a*this.height),this.stageTop=~~(e/2-this.stageHeight/2),this.stageLeft=~~(t/2-this.stageWidth/2),this.zoomRatio=a,this.stageZoom===!1&&(this.stageTop=0>this.stageTop?0:this.stageTop,this.stageLeft=0>this.stageLeft?0:this.stageLeft),$(this.container).css({left:this.stageLeft,top:this.stageTop,width:this.stageWidth,height:this.stageHeight}),1!==this.zoomRatio?$([this.backElement,this.element,this.transElement]).css("zoom",this.zoomRatio):$([this.backElement,this.element,this.transElement]).css("zoom","")},setSkipmode:function(t,e,i){if(t="boolean"==typeof t?t:!0,e="number"==typeof e?e:100,i="boolean"==typeof i?i:!0,this.skipping&&t)return!1;if(t){if(i){var s=this;$(Almight).off(".skiprelease").on("stageclick.skiprelease",function(t,e){void 0===e&&($(Almight).off(".skiprelease"),clearInterval(s.skipTimer),s.skipping=!1)})}this.skipping=!0,this.skipTimer=setInterval(function(){$(Almight).triggerHandler("stageclick","skip")},e)}else clearInterval(this.skipTimer),this.skipping=!1,$(Almight).off(".skiprelease")},toggleSkipmode:function(t,e){this.skipping?this.setSkipmode(!1,t,e):this.setSkipmode(!0,t,e)},setAutomode:function(t,e,i){if(t="boolean"==typeof t?t:!0,e="number"==typeof e?e:1e3,i="boolean"==typeof i?i:!0,this.autoMode&&t)return!1;if(t){if(i){var s=this;$(Almight).off(".autorelease").on("stageclick.autorelease",function(t,e){void 0===e&&($(Almight).off(".autorelease"),s.autoMode=!1)})}this.autoMode=!0,this.autoDelay=e,$(Almight).on("autoclick.autorelease",function(){$(Almight).triggerHandler("stageclick","auto")}),setTimeout(function(){$(Almight).triggerHandler("stageclick","auto")},1e3)}else $(Almight).off(".autorelease"),this.autoMode=!1},toggleAutomode:function(t,e){this.autoMode?this.setAutomode(!1,t,e):this.setAutomode(!0,t,e)},layerCopy:function(t){t=void 0===t?"fore":t;var e="fore"===t?"back":"fore",i=0;for(this.layerCopyTo(this[e].base,this[t].base,t,1),i=0;this.fore.layers.length>i;i++)this.layerCopyTo(this[e].layers[i],this[t].layers[i],t,10+i);for(i=0;this.fore.messages.length>i;i++)this.layerCopyTo(this[e].messages[i],this[t].messages[i],t,100+i);almight.buttonsEvent()},layerCopyTo:function(t,e,i){i="fore"===i?this.element:this.backElement;for(var s=[],a=0;t.children.length>a;a++)s.push($(t.children[a]).clone()[0]),$(s[a]).data($.extend(!0,{},$(t.children[a]).data()));e.children=s,e.parent=t.parent,e.prop=$.extend(!0,{},t.prop),$(e.element).remove(),e.element=$(t.element).clone().appendTo(i)[0],"message"===t.type&&(e.bgElement=$(e.element).find(".almight-layer-msgbg")[0],e.msgElement=$(e.element).find(".almight-layer-message")[0],e.lineLayer=$(e.element).find(".almight-layer-line:last")[0])},toCanvas:function(t){t="fore"===t?this.element:this.backElement;var e=$.Deferred(),i=this;return html2canvas(t,{width:2*this.width,height:2*this.height,onrendered:function(t){var s=$("<canvas/>").attr({width:i.width,height:i.height}).css({width:i.width,height:i.height})[0],a=s.getContext("2d");a.fillStyle="#000000",a.fillRect(0,0,i.width,i.height),a.drawImage(t,0,0,i.width,i.height),e.resolve(s)}}),e.promise()},beginTransition:function(t){clearInterval(this.trans.timer),this.trans={df:$.Deferred(),dfwt:$.Deferred(),rule:null,stime:0,timer:null,usecross:!1,forectx:null,backelem:null,x:0,duration:300},this.transitioning=!0;var e=this;if("universal"===t.method){var i=t.rule;$("<img/>").on({load:function(){e.trans.rule=this,e.readyTransition(t)},error:function(t){e.trans.df.reject(t)}}).attr("src",i)}else("crossfade"===t.method||void 0===t.method)&&(this.trans.usecross=!0,this.readyTransition(t));return this.trans.df.promise()},readyTransition:function(t){var e=this;$.when(this.toCanvas("fore"),this.toCanvas("back")).done(function(i,s){e.trans.forectx=i,e.trans.backelem=s,e.trans.usecross?(e.trans.rule=null,$(e.trans.backelem).css("z-index",1),$(e.transElement).append(e.trans.backelem).show()):e.trans.rule=new Almight.Rule(e.trans.rule,e.width,e.height),e.trans.duration=1.3*t.time,$(e.transElement).append(e.trans.forectx).show(),e.layerCopy("fore"),e.trans.stime=+new Date,e.trans.x=0,e.trans.usecross?$(e.trans.forectx).transition({duration:e.trans.duration,opacity:0,easing:"linear",complete:function(){e.onTransitionCompleted()}}):(e.trans.forectx=e.trans.forectx.getContext("2d"),e.trans.timer=setInterval(function(){e.applyTransition()},1e3/30)),setTimeout(function(){e.trans.df.resolve()},0)})},applyTransition:function(){this.trans.usecross?this.crossfade(this.trans.forectx,this.trans.x):this.trans.rule.applyRule(this.trans.forectx,this.trans.x),this.trans.forectx.globalCompositeOperation="destination-over",this.trans.forectx.drawImage(this.trans.backelem,0,0),this.trans.x=(+new Date-this.trans.stime)/this.trans.duration,this.trans.x>=.75&&this.onTransitionCompleted()},onTransitionCompleted:function(){var t=this;return this.transitioning?(this.transitioning=!1,t.trans.usecross?$(this.trans.forectx).transitionStop(!0,!0):clearInterval(this.trans.timer),this.trans.forectx=null,this.trans.backelem=null,$(this.transElement).hide().empty(),setTimeout(function(){t.trans.dfwt.resolve()},50),void 0):!1},crossfade:function(t,e){t.globalCompositeOperation="xor",t.fillStyle="rgba(0, 0, 0, "+e/3+")",t.fillRect(0,0,this.stageWidth*this.pixelRatio,this.stageHeight*this.pixelRatio)}}}(),function(){Almight.Sound=function(){this.type="bgm",this.method="typeAudio",this.element=null,this.src="",this.playing=!1,this.fading=!1,this.loop=!1,this._loop=!1,this.mute=!1,this.volume=1,this.gvolume=1,this.initialize.apply(this,arguments)},Almight.Sound.prototype={initialize:function(t){this.type=t,"bgm"===t&&(this._loop=!0),window.sf["alm_"+t+"vol"]>=0&&1>=window.sf["alm_"+t+"vol"]?this.gvolume=window.sf["alm_"+t+"vol"]:window.sf["alm_"+t+"vol"]=this.gvolume,this.method=Almight.Platform.viewer?"typeViewer":"typeAudio",this[this.method].initialize.apply(this,arguments)},setPlay:function(){return this[this.method].play.apply(this,arguments)},setPause:function(){this[this.method].pause.apply(this,arguments)},setStop:function(){this[this.method].stop.apply(this,arguments)},toggleMute:function(){this[this.method].mute.apply(this,arguments)},setVolume:function(){this[this.method].volume.apply(this,arguments)},setGvolume:function(t){t>=0&&1>=t&&(this.gvolume=t,window.sf["alm_"+this.type+"vol"]=t,this[this.method].volume.apply(this))},setOptions:function(t){"number"==typeof t.volume&&this[this.method].volume.call(this,t.volume),"number"==typeof t.gvolume&&this.setGvolume(t.gvolume)},fadeTo:function(){return this[this.method].fade.apply(this,arguments)},fadeSkip:function(){this[this.method].fadeskip.apply(this,arguments)},typeAudio:{initialize:function(){var t=this;this.element=new Audio(""),this.element.autoplay=!1,this.element.volume=this.volume*this.gvolume,this.fade_element=$.extend($("<div/>")[0],{volume:this.volume*this.gvolume}),$(this.element).on("ended",function(){t.playing=!1,$(t).triggerHandler("ended")})},play:function(t){var e=$.Deferred(),i=void 0===t.loop?this._loop:t.loop;return $(this.fade_element).stop(!0,!0),$(this.element).one("play",function(){$(this).off("error"),e.resolve()}),this.loop=i,this.src=t.storage,this.playing=!0,this.element.load(),this.element.loop=this.loop,this.element.src=this.src,this.element.play(),e.promise()},pause:function(){$(this.fade_element).stop(!0,!0),this.playing=!1,this.element.pause()},stop:function(){$(this.fade_element).stop(!0,!0),this.playing=!1;try{this.element.pause()}catch(t){}},mute:function(){this.mute=!this.mute,this.element.muted=this.mute},volume:function(t){$(this.element).stop(!0,!0),(null===t||void 0===t)&&(t=this.volume),this.volume=t,this.fade_element.volume=t*this.gvolume,this.element.volume=t*this.gvolume},fade:function(t,e,i){var s=$.Deferred(),a=this;return t="number"!=typeof t?this.volume*this.gvolume:t,e="number"!=typeof e?this.volume*this.gvolume:e,this.element.volume=t,this.fade_element.volume=t,this.fading=!0,$(this.fade_element).stop(!0,!0).animate({volume:e},{easing:"linear",duration:i,step:function(){a.element.volume=this.volume},complete:function(){a.element.volume=this.volume,a.fading=!1,a.setVolume(null),s.resolve()}}),s.promise()},fadeskip:function(){$(this.fade_element).stop(!0,!0)}},typeViewer:{initialize:function(){this.fade_element=$.extend($("<div/>")[0],{volume:this.volume*this.gvolume}),Titanium.App.fireEvent("createSound",{name:this.type});var t=this;setTimeout(function(){t.setVolume()},100)},play:function(t){var e=$.Deferred(),i=void 0===t.loop?this._loop:t.loop;return $(this.fade_element).stop(!0,!0),this.loop=i,this.src=t.storage,this.playing=!0,Titanium.App.fireEvent("setPlaySound",{name:this.type,loop:this.loop,src:this.src}),setTimeout(function(){e.resolve()},0),e.promise()},playend:function(){this.playing=!1,$(this).triggerHandler("ended")},pause:function(){$(this.fade_element).stop(!0,!0),this.playing=!1,Titanium.App.fireEvent("setStopSound",{name:this.type})},stop:function(){$(this.fade_element).stop(!0,!0),this.playing=!1;try{Titanium.App.fireEvent("setStopSound",{name:this.type})}catch(t){}},mute:function(){this.mute=!this.mute},volume:function(t){(null===t||void 0===t)&&(t=this.volume),this.volume=t,this.fade_element.volume=t*this.gvolume,Titanium.App.fireEvent("setVolumeSound",{name:this.type,volume:t*this.gvolume})},fade:function(t,e,i){var s=$.Deferred(),a=this;return t="number"!=typeof t?this.volume*this.gvolume:t*this.gvolume,e="number"!=typeof e?this.volume*this.gvolume:e*this.gvolume,this.fade_element.volume=t,this.fading=!0,$(this.fade_element).stop(!0,!0).animate({volume:e},{easing:"linear",duration:i,step:function(){Titanium.App.fireEvent("setVolumeSound",{name:a.type,volume:this.volume})},complete:function(){a.fading=!1,a.setVolume(null),s.resolve()}}),s.promise()}}}}(),function(){"use strict";Almight.Layer=function(){this.type="layer",this.element=null,this.children=[],this.parent=null,this.prop={top:0,left:0,width:1136,height:640,opacity:1,visible:!1},this.initialize.apply(this,arguments)},Almight.Layer.prototype={initialize:function(t,e){this.element=$("<div/>").addClass("almight-layer").css({width:t,height:e,top:0,left:0})[0],this.prop.width=t,this.prop.height=e},loadImages:function(t,e,i){var s=$.Deferred(),a=this,n=null;return void 0!==i&&(n=$(this.element).find("."+i),0===n.length&&(n=null)),null===n&&(n=$("<img/>")),n.addClass("almight-layer-image").on({load:function(){e&&a.freeImage(),$(this).attr({width:this.width,height:this.height}).css({width:this.width,height:this.height}).data({type:"image",storage:t,dx:0,dy:0}),void 0!==i&&$(this).addClass(i),a.children.push(this),s.resolve(this)},error:function(t){s.reject(t)}}).attr("src",t),s.promise()},freeImage:function(){for(var t=0;this.children.length>t;t++)"IMG"===this.children[t].tagName&&$(this.children[t]).attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"),$(this.children[t]).remove(),this.children[t]=null;return this.children=[],$(this.element).empty(),this},setOptions:function(t){void 0!==t.visible&&"base"!==this.type&&this.setVisible(t.visible),void 0!==t.left&&"base"!==this.type&&this.setLeft(t.left),void 0!==t.top&&"base"!==this.type&&this.setTop(t.top),void 0!==t.opacity&&this.setOpacity(t.opacity/255)},setLeft:function(t){this.prop.left=t,$(this.element).css("left",t)},getLeft:function(){return this.prop.left},setTop:function(t){this.prop.top=t,$(this.element).css("top",t)},setPos:function(t,e){this.setLeft(t),this.setTop(e)},getTop:function(){return this.prop.top},setWidth:function(t){this.prop.width=t,$(this.element).css("width",t)},getWidth:function(){return this.prop.width},setHeight:function(t){this.prop.height=t,$(this.element).css("height",t)},getHeight:function(){return this.prop.height},setOpacity:function(t){t>=0&&1>=t&&(this.prop.opacity=t,$(this.element).css("opacity",t))},getOpacity:function(){return this.prop.opacity},setVisible:function(t){t?(this.prop.visible=!0,$(this.element).show()):(this.prop.visible=!1,$(this.element).hide())},getVisible:function(){return this.prop.visible},getStorage:function(t){return void 0===this.children[t]?void 0:this.children[t].src.match(/\/([^/]+)$/)[1]},animateQueue:function(t){var e=this;return t=$.extend(!0,{},t),$(this.element).queue("animate",function(){var i=e.prop.left,s=e.prop.top;void 0!==t.time&&(t.duration=t.time),void 0!==t.left&&(t.x=t.left),void 0!==t.top&&(t.y=t.top),void 0!==t.x&&(e.prop.left=parseInt(t.x,10)),void 0!==t.y&&(e.prop.top=parseInt(t.y,10)),void 0!==t.opacity&&(e.prop.opacity=Number(t.opacity)),void 0===t.easing&&(t.easing="in-out"),void 0!==t.x&&(t.x-=i),void 0!==t.y&&(t.y-=s),(void 0===t.delay||0>=t.delay)&&(t.delay=1);var a=["easing","duration","x","y","opacity","translate","rotate","rotateX","rotateY","rotate3d","scale","perspective","skewX","skewY","delay"];for(var n in t)-1===a.indexOf(n)&&delete t[n];t.complete=function(){void 0!==t.x&&$(e.element).css({x:0,left:e.prop.left}),void 0!==t.y&&$(e.element).css({y:0,top:e.prop.top});var i=this;setTimeout(function(){0===$(i).queue("animate").length?$(i).triggerHandler("animateEnd"):$(i).dequeue("animate")},0)},$(e.element).transition(t)}),e},animateStart:function(){$(this.element).dequeue("animate")},setSizeToImageSize:function(){},fillRect:function(t){var e,i,s;void 0===t.rgba?(e=void 0===t.color?"#ffffff":t.color,i=void 0===t.opacity?1:t.opacity/255,s=Almight.Util.rgba(e,i)):s=t.rgba;var a=void 0===t.top?0:t.top,n=void 0===t.left?0:t.left,o=void 0===t.width?100:t.width,r=void 0===t.height?100:t.height,l=void 0===t.zIndex?this.children.length:t.zIndex,h=$("<div/>").css({position:"absolute",top:a,left:n,width:o,height:r,"background-color":s,"z-index":l}).data({type:"fill",left:n,top:a,width:o,height:r,rgba:s,zIndex:l});this.children.push(h),$(this.element).append(h)}}}(),function(){"use strict";Almight.GraphicLayer=function(){void 0===this._super&&(this._super={}),this._super=Almight.Layer,this._super.apply(this,arguments),this._super=this._super.prototype,this.graphicLayerInitialize.apply(this,arguments)},Almight.GraphicLayer.prototype={graphicLayerInitialize:function(){this.type="graphic"},loadImages:function(t,e){var i=$.Deferred(),s=this,a=t.storage,n=void 0===t.zIndex?this.children.length:t.zIndex;return e&&(n=-1),$.isEmptyObject(t)?(this.freeImage(),!0):(s._super.loadImages.call(s,a,e,t.id).then(function(e){if("base"!==s.type)if(void 0!==t.pos)if(t.pos in almight.config.position){var a=almight.config.position[t.pos];a-=e.naturalWidth/2,s.setLeft(a),s.setTop(almight.config.height-e.naturalHeight)}else Almight.error("pos属性に指定されている位置情報が見つかりません");else"number"==typeof t.left&&s.setLeft(t.left),"number"==typeof t.top&&s.setTop(t.top);$(e).css("z-index",n).data("zIndex",n),"boolean"==typeof t.visible&&"base"!==s.type&&s.setVisible(t.visible),"number"==typeof t.opacity&&s.setOpacity(t.opacity/255),s.applyColorCorrection(e,t),$(s.element).append(e),i.resolve()},function(){i.reject("画像の読み込みに失敗しました: "+a)}),i.promise())},loadPartialImage:function(t){var e=$.Deferred(),i=this,s=t.storage,a=void 0===t.zIndex?this.children.length:t.zIndex;return i._super.loadImages.call(i,s,t.key,t.id).then(function(s){var n="number"==typeof t.dx?t.dx:0,o="number"==typeof t.dy?t.dy:0;"number"==typeof t.opacity&&$(s).css("opacity",t.opacity/255),$(s).css({left:n,top:o,bottom:"auto",zIndex:a}).data({type:"pimage",dx:n,dy:o,opacity:t.opacity,zIndex:a}),$(i.element).append(s),e.resolve()},function(){e.reject("画像の読み込みに失敗しました: "+s)}),e.promise()},applyColorCorrection:function(t,e){var i="";(e.grayscale===!0||"number"==typeof e.grayscale&&e.grayscale>=0&&1>=e.grayscale)&&(i+=" grayscale("+(e.grayscale===!0?1:e.grayscale)+")"),"number"==typeof e.blur&&(i+=" blur("+e.blur+"px)"),"string"==typeof e.shadow&&(i+=" drop-shadow("+e.shadow+")"),""!==i&&$(t).css("-webkit-filter",i)},dump:function(){for(var t=$.extend(!0,{},{prop:this.prop,children:[]}),e=0;this.children.length>e;e++)t.children[e]=$(this.children[e]).data();return t},restore:function(t){this.prop=$.extend(!0,{},t.prop),this.freeImage();for(var e=0;t.children.length>e;e++)"image"===t.children[e].type&&this.loadImages(t.children[e]),"pimage"===t.children[e].type&&this.loadPartialImage(t.children[e]),"fill"===t.children[e].type&&this.fillRect(t.children[e]);this.setLeft(this.prop.left),this.setTop(this.prop.top),this.setWidth(this.prop.width),this.setHeight(this.prop.height),this.setVisible(this.prop.visible)}},Almight.GraphicLayer.prototype=$.extend({},Almight.Layer.prototype,Almight.GraphicLayer.prototype)}(),function(){"use strict";Almight.MessageLayer=function(){void 0===this._super&&(this._super={}),this._super=Almight.Layer,this._super.apply(this,arguments),this._super=this._super.prototype,this.messageLayerInitialize.apply(this,arguments)},Almight.MessageLayer.prototype={messageLayerInitialize:function(t,e,i,s){this.type="message",$(this.element).attr("class","almight-message-layer"),$.extend(!0,this.prop,{frameGraphic:"",frameColor:"#000000",frameOpacity:128,marginl:8,margint:8,marginr:8,marginb:8,left:16,top:16,font:{},style:{},deffont:{},defstyle:{},animateBegin:{opacity:0},animateEnd:{opacity:1},animateTime:100,animateMobile:!1},s),$.extend(!0,this.prop.deffont,{size:24,face:"serif",color:"#ffffff",bold:!0,italic:!1,shadowcolor:"#000000",shadowpos:"2px 2px 5px",shadow:!0},s.deffont),$.extend(!0,this.prop.defstyle,{lineheight:6,pitch:0,align:"left"},s.defstyle),this.bgElement=$("<div/>").addClass("almight-layer-msgbg").css({width:t,height:e,left:0,top:0})[0],$(this.element).append(this.bgElement),this.msgElement=$("<div/>").addClass("almight-layer-message").css({left:0,top:0})[0],$(this.element).append(this.msgElement),this.linking=!1,this.setTop(this.prop.top),this.setLeft(this.prop.left),this.setMessageFrame(),this.setSizeToImageSize(),this.clear()},initLineLayer:function(){var t="left"===this.prop.defstyle.align?"inline":"block";"left"!==this.prop.style.align&&void 0!==this.prop.style.align&&(t="block"),this.lineLayer=$("<div/>").addClass("almight-layer-line").css({fontSize:this.prop.deffont.size,fontFamily:this.prop.deffont.face,color:this.prop.deffont.color,fontWeight:this.prop.deffont.bold?"bold":"",fontStyle:this.prop.deffont.italic?"italic":"",textShadow:this.prop.deffont.shadow?this.prop.deffont.shadowpos+" "+this.prop.deffont.shadowcolor:"",lineHeight:(this.prop.style.lineheight||this.prop.defstyle.lineheight)+(this.prop.font.size||this.prop.deffont.size)+"px",letterSpacing:(this.prop.style.pitch||this.prop.defstyle.pitch)+"px",textAlign:this.prop.style.align||this.prop.defstyle.align,display:t}),$(this.msgElement).append(this.lineLayer)},clear:function(){$(this.element).find(".almight-button").remove(),this.resetFonts(),this.resetStyles(),this.clearLayer()},clearLayer:function(){$(this.msgElement).empty(),this.initLineLayer()},setMessageFrame:function(){$(this.msgElement).css({left:this.prop.marginl,top:this.prop.margint,right:this.prop.marginr,bottom:this.prop.marginb}),this.setLeft(this.prop.left),this.setTop(this.prop.top),this.setWidth(this.prop.width),this.setHeight(this.prop.height),this.setVisible(this.prop.visible);var t={height:this.prop.height,width:this.prop.width};""===this.prop.frameGraphic?($.extend(t,{backgroundColor:Almight.Util.rgba(this.prop.frameColor,this.prop.frameOpacity/256),backgroundImage:""}),$(this.bgElement).empty()):($.extend(t,{backgroundColor:"",backgroundImage:""}),$(this.bgElement).empty().append('<img src="'+Almight.Util.getPath(this.prop.frameGraphic)+'"/>')),$(this.bgElement).css(t)},setPosition:function(t){"number"==typeof t.left&&(this.prop.left=t.left),"number"==typeof t.top&&(this.prop.top=t.top),"number"==typeof t.width&&(this.prop.width=t.width),"number"==typeof t.height&&(this.prop.height=t.height),this.setSizeToImageSize(),"string"==typeof t.frame&&(this.prop.frameGraphic=t.frame),"string"==typeof t.color&&(this.prop.frameColor=t.color),"number"==typeof t.opacity&&(this.prop.frameOpacity=t.opacity),"number"==typeof t.marginl&&(this.prop.marginl=t.marginl),"number"==typeof t.margint&&(this.prop.margint=t.margint),"number"==typeof t.marginr&&(this.prop.marginr=t.marginr),"number"==typeof t.marginb&&(this.prop.marginb=t.marginb),"boolean"==typeof t.vertical&&(this.prop.vertical=t.vertical),"boolean"==typeof t.visible&&(this.prop.visible=t.visible),this.setMessageFrame(),this.clear()},setStyles:function(t){void 0!==t.align&&(this.prop.style.align=t.align),void 0!==t.lineheight&&(this.prop.style.lineheight=t.lineheight),void 0!==t.pitch&&(this.prop.style.pitch=t.pitch),"default"===t.align&&delete this.prop.style.align,"default"===t.lineheight&&delete this.prop.style.lineheight,"default"===t.pitch&&delete this.prop.style.pitch,this.initLineLayer()},setFonts:function(t){void 0!==t.size&&(this.prop.font.fontSize=t.size),void 0!==t.face&&(this.prop.font.fontFamily=t.face),void 0!==t.color&&(this.prop.font.color=Almight.Util.rgba(t.color)),void 0!==t.shadowcolor&&"default"!==t.shadowcolor&&(this.prop.font.shadowcolor=Almight.Util.rgba(t.shadowcolor)),void 0!==t.shadowpos&&"default"!==t.shadowpos&&(this.prop.font.shadowpos=t.shadowpos),void 0===t.shadow&&(t.shadow=this.prop.deffont.shadow),t.shadow!==!0&&"default"!==t.shadow||void 0===t.shadowcolor&&void 0===t.shadowpos||(this.prop.font.textShadow=void 0!==this.prop.font.shadowpos?this.prop.font.shadowpos:this.prop.deffont.shadowpos,this.prop.font.textShadow+=" "+(void 0!==this.prop.font.shadowcolor?this.prop.font.shadowcolor:this.prop.deffont.shadowcolor)),t.shadow===!1&&(this.prop.font.textShadow="none"),void 0!==t.bold&&(this.prop.font.fontWeight=t.bold?"bold":""),"default"===t.size&&delete this.prop.font.fontSize,"default"===t.face&&delete this.prop.font.fontFamily,"default"===t.color&&delete this.prop.font.color,"default"===t.shadow&&this.prop.deffont.shadow===!1&&(this.prop.font.textShadow="none"),"default"===t.shadowcolor&&delete this.prop.font.shadowcolor,"default"===t.shadowpos&&delete this.prop.font.shadowpos,"default"===t.bold&&delete this.prop.font.fontWeight},setDefStyles:function(t){void 0!==t.align&&(this.prop.defstyle.align=t.align),void 0!==t.lineheight&&(this.prop.defstyle.lineheight=t.lineheight),void 0!==t.pitch&&(this.prop.defstyle.pitch=t.pitch)},setDefFonts:function(t){void 0!==t.size&&(this.prop.deffont.size=t.size),void 0!==t.face&&(this.prop.deffont.face=t.face),void 0!==t.color&&(this.prop.deffont.color=Almight.Util.rgba(t.color)),void 0!==t.shadowcolor&&(this.prop.deffont.shadowcolor=Almight.Util.rgba(t.shadowcolor)),void 0!==t.shadowpos&&(this.prop.deffont.shadowpos=t.shadowpos),void 0!==t.shadow&&(this.prop.deffont.shadow=t.shadow),void 0!==t.bold&&(this.prop.deffont.bold=t.bold)
},resetFonts:function(){this.prop.font={}},resetStyles:function(){this.prop.style={},this.initLineLayer()},processCh:function(t,e){for(var i=[],s=[],a=0;t.length>a;a++){var n=t.charAt(a);" "===n&&(n="&nbsp;"),i[a]=$('<span class="almight-ch">'+n+"</span>").css(this.prop.font),this.linking&&i[a].addClass("almight-linking"),this.prop.animateMobile&&!e?(i[a].css(this.prop.animateBegin).appendTo(this.lineLayer),s[a]=$.extend(!0,{},this.prop.animateEnd,{duration:this.prop.animateTime}),function(t){setTimeout(function(){i[t].transition(s[t]),i[t]=null,s[t]=null},0)}(a)):i[a].appendTo(this.lineLayer)}},dump:function(){var t=$(this.element).clone();t=t.html();var e=$.extend(!0,{},{prop:this.prop,dom:t});return e},restore:function(t){this.prop=$.extend(!0,{},t.prop),this.clear(),$(this.element).html(t.dom),this.bgElement=$(this.element).find(".almight-layer-msgbg")[0],this.msgElement=$(this.element).find(".almight-layer-message")[0],this.setMessageFrame(),this.lineLayer=$(this.element).find(".almight-layer-line:last")[0]}},Almight.MessageLayer.prototype=$.extend({},Almight.Layer.prototype,Almight.MessageLayer.prototype)}(),function(){"use strict";Almight.Rule=function(t,e,i){this.img=t,this.width=e,this.height=i,this._tmpcA=document.createElement("canvas"),this._ca=this._tmpcA.getContext("2d"),this._tmpcA.width=e,this._tmpcA.height=i;var s=this._tmpcB=document.createElement("canvas");this._cb=s.getContext("2d"),s.width=e,s.height=i;var a=this._alpha1=document.createElement("canvas"),n=a.getContext("2d"),o=this._alpha2=document.createElement("canvas"),r=o.getContext("2d");a.width=e,a.height=i,o.width=e,o.height=i,n.drawImage(t,0,0,e,i);var l=n.getImageData(0,0,e,i);Array.prototype.unshift.call(l.data,0),Array.prototype.pop.call(l.data),n.putImageData(l,0,0),r.fillStyle="#000000",r.globalCompositeOperation="xor",r.fillRect(0,0,e,i),r.drawImage(a,0,0,e,i)},Almight.Rule.prototype={makeRule:function(t){var e=this._ca,i=this._cb;return this._tmpcA.width=this._tmpcA.width,this._tmpcB.width=this._tmpcB.width,.5>=t?(i.drawImage(this._alpha1,0,0),i.globalCompositeOperation="lighter",i.fillStyle="rgba(0,0,0,"+(1-2*t)+")",i.fillRect(0,0,this.width,this.height),e.fillStyle="#000000",e.fillRect(0,0,this.width,this.height),e.globalCompositeOperation="xor",e.drawImage(this._tmpcB,0,0,this.width,this.height)):t>.5&&(e.drawImage(this._alpha2,0,0,this.width,this.height),e.globalCompositeOperation="lighter",e.fillStyle="rgba(0,0,0,"+2*(t-.5).toFixed(5)+")",e.fillRect(0,0,this.width,this.height)),this._tmpcA},applyRule:function(t,e){return t.globalCompositeOperation="xor",t.drawImage(this.makeRule(e),0,0),t}}}(),function(){"use strict";Almight.Tag=function(t){this.almight=t,this.stage=t.stage,this.hactexp=null},Almight.Tag.prototype={_void_:function(){return 1},_endmacro_:function(t){var e=this.almight.script.macrostack.pop();return window.mp=0===this.almight.script.macrostack.length?{}:this.almight.script.macrostack[0].attr,this.almight.debug&&console.groupEnd("["+e.name+"]"),t=null,1},_label_:function(t){return this.almight.debug&&console.log("ラベルを通過: "+t.id+" "+t.name),1},_text_:function(t){var e=(t.text||"")+"",i=this.almight.config.chspeed;this.almight.debug&&console.log(e);var s=i.nowaiting?0:i[i.actual],a=this;if(this.stage.skipping&&(s=0),s>0){var n,o=e.split("");return this.almight.stage.textAnimating=!0,$(Almight).off(".animateEnd").one("stageclick.animateEnd",function(){clearInterval(n),o.length>0&&(a.almight.config.chspeed.nowaiting=!0,$(Almight).one("userwait.nowaiting",function(){a.almight.config.chspeed.nowaiting=!1}),a.ch({text:o.join("")})),a.almight.config.messages.animateMobile?setTimeout(function(){a.almight.stage.textAnimating=!1,a.almight.script.dequeue()},a.almight.config.messages.animateTime):(a.almight.stage.textAnimating=!1,a.almight.script.dequeue())}),n=setInterval(function(){a.ch({text:o[0]}),o.shift(),0>=o.length&&$(Almight).triggerHandler("stageclick.animateEnd")},s),2}return this.ch({text:e}),1},clearsysvar:function(){return window.sf={},1},close:function(t){var e=this;return t.ask===!1?(window.close(),location.href="about:blank"):almight.UI.dialog({text:"ゲームを終了しますか？",button:[{text:"キャンセル",callback:function(){e.almight.script.dequeue()}},{text:"OK",type:"done",callback:function(){e.almight.exit()}}]}),0},hidemessage:function(){var t=this;return $(Almight).off(".hidemessage").one("stageclick.hidemessage",function(){$(t.almight.stage.element).find(".almight-message-layer").css("visibility",""),setTimeout(function(){t.almight.stage.canClick=!0},0)}),$(Almight).one("hideSidebar",function(){t.almight.stage.canClick=!1}),$(this.almight.stage.element).find(".almight-message-layer").css("visibility","hidden"),1},loadjs:function(t){if(void 0!==t.src){var e=this;return $.ajax({url:Almight.Util.getPath(t.src),dataType:"script"}).done(function(){e.almight.script.dequeue()}).fail(function(t){console.error(t.message),Almight.error("[loadjs] JavaScriptファイルを読み込めませんでした")}),2}return 1},quake:function(t){void 0===t.time&&Almight.error("[quake] にはtime属性が必須です");var e,i=void 0!==t.hmax?t.hmax:10,s=void 0!==t.vmax?t.vmax:10,a=void 0!==t.interval?t.interval:30;e=void 0===t.layer?$(this.almight.stage.container):$(this.stage.getLayerFromParams(t).element);var n=setInterval(function(){e.css({x:parseInt(Math.random()*2*i,10)-i,y:parseInt(Math.random()*2*s,10)-s})},a);e.one("quakeEnd",function(){clearTimeout(o),clearInterval(n),$(Almight).off(".quakeskip"),e.css({x:0,y:0}).data("quaking",!1).triggerHandler("quakeEnded")}).data("quaking",!0);var o=setTimeout(function(){e.triggerHandler("quakeEnd")},t.time);return 1},stopquake:function(t){var e;return e=void 0===t.layer?$(this.almight.stage.container):$(this.stage.getLayerFromParams(t).element),e.triggerHandler("quakeEnd"),1},wq:function(t){var e,i=void 0===t.canskip?!1:t.canskip;return e=void 0===t.layer?$(this.almight.stage.container):$(this.stage.getLayerFromParams(t).element),e.data("quaking")!==!0?1:(e.one("quakeEnded",function(){$(Almight).off(".quakeskip"),self.almight.script.dequeue()}),i&&$(Almight).off(".quakeskip").one("stageclick.quakeskip",function(){e.triggerHandler("quakeEnd")}),2)},s:function(){return 0},title:function(t){return void 0===t.name&&Almight.error("[title] にはname属性が必須です"),this.almight.config.title=(t.name||"")+"",document.title=this.almight.config.title,1},wait:function(t){"number"!=typeof t.time&&Almight.error("[wait] にはnumber型のtime属性が必須です");var e="boolean"==typeof t.canskip?t.canskip:!0,i=this,s=setTimeout(function(){$(Almight).off(".waitskip"),i.almight.script.dequeue()},t.time);return e&&$(Almight).off(".waitskip").one("stageclick.waitskip",function(){clearTimeout(s),i.almight.script.dequeue()}),2},waitclick:function(){return this._clickwait_("wait"),this.stage.skipping&&this.stage.setSkipmode(!1),0},macro:function(t){void 0===name&&Almight.error("[macro] にはname属性が必須です");var e=(t.name+"").toLowerCase();this.almight.script.macro[e]=[];for(var i=!0;i;){this.almight.script.line++;var s=this.almight.script.scenario[this.almight.script.scenario_name][this.almight.script.line];"endmacro"===s._type_?i=!1:this.almight.script.macro[e].push(s)}if(void 0!==t.alias){var a=(t.alias+"").toLowerCase();this.almight.script.macro[a]=this.almight.script.macro[e]}return this.almight.debug&&console.info("["+e+"]をマクロとして記録しました"),1},erasemacro:function(t){void 0===t.name&&Almight.error("[erasemacro] にはmacro属性が必須です");var e=(t.name+"").toLowerCase();return delete this.almight.script.macro[e],1},endmacro:function(){return console.warn("endmacroタグが重複して記述されている可能性があります"),1},cancelskip:function(){return this.stage.skipping&&this.stage.setSkipmode(!1),1},cancelauto:function(){return this.stage.autoMode&&this.stage.setAutomode(!1),1},er:function(){return this.stage.current.clear(),1},cm:function(){for(var t=0;this.stage.fore.messages.length>t;t++)this.stage.fore.messages[t].clear(),this.stage.back.messages[t].clear();return 1},ct:function(){for(var t=0;this.stage.fore.messages.length>t;t++)this.stage.fore.messages[t].clear(),this.stage.back.messages[t].clear();return this.stage.setCurrentMessageLayer({page:"fore",layer:"message0"}),1},ch:function(t){return(void 0===t.text||null===t.text)&&(t.text=""),this.stage.historyOutput&&$("#almight-history-box p:last").append("<span>"+t.text+"</span>"),this.stage.current.processCh(t.text,this.stage.skipping),1},current:function(t){return this.stage.setCurrentMessageLayer(t),1},font:function(t){return this.stage.current.setFonts(t),1},style:function(t){return this.stage.current.setStyles(t),1},deffont:function(t){return this.stage.current.setDefFonts(t),1},defstyle:function(t){return this.stage.current.setDefStyles(t),1},resetfont:function(){return this.stage.current.resetFonts(),1},resetstyle:function(){return this.stage.current.resetStyles(),1},chanimbegin:function(){return 1},chanimend:function(){},chanimtime:function(){},graph:function(t){var e;void 0!==t.storage&&(e=Almight.Util.getPath(t.storage));var i=$("<img/>").addClass("almight-graph").attr("src",e);return $(this.almight.stage.current.msgElement).find(".almight-layer-line:last").append(i),i=null,1},nowait:function(){return this.almight.config.chspeed.tmp=this.almight.config.chspeed.actual,this.almight.config.chspeed.actual="nowait",1},endnowait:function(){return this.almight.config.chspeed.actual=this.almight.config.chspeed.tmp,1},delay:function(t){return void 0===t.speed&&Almight.error("[delay] にはspeed属性が必須です"),"number"==typeof t.speed?(this.almight.config.chspeed.tmp=this.almight.config.chspeed.actual,this.almight.config.chspeed.actual="delay",this.almight.config.chspeed.delay=t.speed):"user"===t.speed?this.almight.config.chspeed.actual=this.almight.config.chspeed.tmp:"nowait"===t.speed&&(this.almight.config.chspeed.tmp=this.almight.config.chspeed.actual,this.almight.config.chspeed.actual="nowait"),1},l:function(){return this._clickwait_("line"),0},p:function(){return this._clickwait_("page"),this.stage.historyOutput&&$("#almight-history-box p:last").append("<br>"),0},r:function(){return $(this.almight.stage.current.lineLayer).append("<br/>"),this.stage.historyOutput&&$("#almight-history-box p:last").append("<br/>"),1},_clickwait_:function(t){var e,i=this;this.almight.stage.clickWaiting=t,$(this.almight.stage.current.msgElement).find(".almight-breaker").remove(),("page"===t||"line"===t)&&(e=$("<span/>").addClass("almight-breaker").addClass("almight-break-"+t)[0],$(this.almight.stage.current.lineLayer).append(e)),$(Almight).off(".clickwait").on("stageclick.clickwait",function(){i.almight.stage.canClick&&($(Almight).off(".clickwait"),$(e).remove(),e=null,i.almight.stage.clickWaiting="",i.almight.script.dequeue())}),this.almight.stage.autoMode&&"wait"!==t&&setTimeout(function(){$(Almight).triggerHandler("autoclick")},this.almight.stage.autoDelay)},position:function(t){return this.stage.getMessageLayerObjectFromParams(t).setPosition(t),1},hact:function(t){return this.stage.historyOutput?($("#almight-history-box p:last").append("<p/>"),$("#almight-history-box p:last").wrap("<em/>"),this.hactexp=t.exp,1):1},endhact:function(){return this.stage.historyOutput?(null!==this.hactexp&&void 0!==this.hactexp&&($.data($("#almight-history-box em:last")[0],"hact",this.hactexp),$("#almight-history-box em:last").addClass("hactlink").on("tap",function(){Almight.exec($.data(this,"hact"),!0)}),$("#almight-history-box").append("<p/>")),this.hactexp=null,1):1},history:function(t){return"boolean"==typeof t.output&&(this.stage.historyOutput=t.output),"boolean"==typeof t.enabled&&(this.stage.historyEnabled=t.enabled),1},historytext:function(t){return this.stage.historyOutput&&$("#almight-history-box p:last").append("<span>"+t.text+"</span>"),1},hr:function(){return this.stage.historyOutput&&$("#almight-history-box p:last").append("<br/>"),1},button:function(t){var e=this,i="";void 0!==t.graphic&&(i=Almight.Util.getPath(t.graphic)),void 0!==t.storage&&(t.storage=Almight.Util.getPath(t.storage)),void 0!==t.enterse&&(t.enterse=Almight.Util.getPath(t.enterse)),void 0!==t.leavese&&(t.leavese=Almight.Util.getPath(t.leavese)),void 0!==t.clickse&&(t.clickse=Almight.Util.getPath(t.clickse));var s="fore"===this.almight.stage.currentPage?this.almight.stage.element:this.almight.stage.backElement;return s=this.almight.stage.current.element,$("<img/>").on("load",function(){var a=this.width,n=this.height,o=$("<div/>").addClass("almight-button").css({width:a/3,height:n,top:e.almight.stage.locate.y,left:e.almight.stage.locate.x,"background-image":"url("+i+")"}).attr({"data-width":a/3,"data-storage":t.storage,"data-target":t.target,"data-exp":t.exp,"data-onenter":t.onenter,"data-onleave":t.onleave,"data-clickse":t.clickse,"data-clicksebuf":t.clicksebuf,"data-enterse":t.enterse,"data-entersebuf":t.entersebuf,"data-leavese":t.leavese,"data-leavesebuf":t.leavesebuf});$(s).append(o),e.almight.buttonsEvent(),$(this).remove(),e.almight.script.dequeue()}).on("error",function(){Almight.error("[button] ボタン画像の読み込みに失敗しました")}).attr("src",i),2},locate:function(t){return this.stage.current.initLineLayer(),this.almight.stage.locate={x:"number"==typeof t.x?t.x+this.stage.current.prop.marginl:0,y:"number"==typeof t.y?t.y+this.stage.current.prop.margint:0},$(this.stage.current.lineLayer).css({position:"absolute",left:t.x,top:t.y,width:"100%"}),1},call:function(t){return this.almight.script.callstack.push({storage:this.almight.script.scenario_name,line:this.almight.script.line}),this.jump(t)},"return":function(t){0>=this.almight.script.callstack.length&&Almight.error("[return] call元が見つかりません。callとreturnのバランスが崩れている可能性があります");var e=this.almight.script.callstack.pop();return void 0===t.storage&&void 0===t.target&&(t.storage=e.storage,t.line=t.storage===this.almight.script.scenario_name?e.line:e.line+1),this.jump(t)},choices:function(t){0!==$("#almight-choices").size()&&Almight.error("[choices] 既に選択肢が表示されています"),$(this.stage.element).append('<div id="almight-choices-window"><div class="almight-choices-box"></div></div>');for(var e=1,i=[];void 0!==t["text"+e];){var s=!0;void 0!==t["cond"+e]&&(Almight.exec(t["cond"+e])||(s=!1)),s&&i.push({text:t["text"+e],target:t["target"+e],exp:t["exp"+e],onenter:t["onenter"+e],onleave:t["onleave"+e],storage:t["storage"+e],enterse:t["enterse"+e],leavese:t["leavese"+e],clickse:t["clickse"+e],entersebuf:t["entersebuf"+e],leavesebuf:t["leavesebuf"+e],clicksebuf:t["clicksebuf"+e]}),e++}if(0===i.length)return 1;for(e=0;i.length>e;e++){var a=$("<div/>").addClass("ui-choices").addClass("almight-choices").hide().html(i[e].text);void 0!==i[e].enterse&&(i[e].enterse=Almight.Util.getPath(i[e].enterse)),void 0!==i[e].leavese&&(i[e].leavese=Almight.Util.getPath(i[e].leavese)),void 0!==i[e].clickse&&(i[e].clickse=Almight.Util.getPath(i[e].clickse)),void 0!==i[e].target&&a.attr("data-target",i[e].target),void 0!==i[e].storage&&a.attr("data-storage",i[e].storage),void 0!==i[e].exp&&a.attr("data-exp",i[e].exp),void 0!==i[e].onenter&&a.attr("data-onenter",i[e].onenter),void 0!==i[e].onleave&&a.attr("data-onleave",i[e].onleave),void 0!==i[e].enterse&&a.attr("data-enterse",i[e].enterse),void 0!==i[e].leavese&&a.attr("data-leavese",i[e].leavese),void 0!==i[e].clickse&&a.attr("data-clickse",i[e].clickse),void 0!==i[e].entersebuf&&a.attr("data-entersebuf",i[e].entersebuf),void 0!==i[e].leavesebuf&&a.attr("data-leavesebuf",i[e].leavesebuf),void 0!==i[e].clicksebuf&&a.attr("data-clicksebuf",i[e].clicksebuf),$("#almight-choices-window .almight-choices-box").append(a),a=null}return $("#almight-choices-window").fadeIn(200,function(){$(this).css("display","table").find(".ui-choices").show()}),this.almight.buttonsEvent(),0},link:function(t){this.stage.current.linking=!0;var e=$('<a class="almight-link"/>'),i=this;return void 0!==t.enterse&&(t.enterse=Almight.Util.getPath(t.enterse)),void 0!==t.leavese&&(t.leavese=Almight.Util.getPath(t.leavese)),void 0!==t.clickse&&(t.clickse=Almight.Util.getPath(t.clickse)),void 0!==t.storage&&e.attr("data-storage",t.storage),void 0!==t.target&&e.attr("data-target",t.target),void 0!==t.exp&&e.attr("data-exp",t.exp),void 0!==t.onenter&&e.attr("data-onenter",t.onenter),void 0!==t.onleave&&e.attr("data-onleave",t.onleave),void 0!==t.enterse&&e.attr("data-enterse",t.enterse),void 0!==t.leavese&&e.attr("data-leavese",t.leavese),void 0!==t.clickse&&e.attr("data-clickse",t.clickse),void 0!==t.entersebuf&&e.attr("data-entersebuf",t.entersebuf),void 0!==t.leavesebuf&&e.attr("data-leavesebuf",t.leavesebuf),void 0!==t.clicksebuf&&e.attr("data-clicksebuf",t.clicksebuf),$(this.stage.current.lineLayer).one("endlink",function(){i.stage.current.linking=!1,$(this).find(".almight-linking").removeClass("almight-linking").wrapAll(e),i.almight.buttonsEvent()}),1},endlink:function(){return $(this.stage.current.lineLayer).triggerHandler("endlink"),1},jump:function(t){var e=this;void 0!==t.storage&&(t.storage=Almight.Util.getPath(t.storage));var i="",s=function(){if(/^\*/.test(t.target))if(i=t.target.replace(/^\*/,""),i in e.almight.script.label[e.almight.script.scenario_name]){var a=e.almight.script.label[e.almight.script.scenario_name][i];e.almight.script.line=a.line}else Almight.error("[jump] 指定されているラベル名は存在していません");else e.almight.script.line=0;s=null};return void 0!==t.storage&&t.storage===this.almight.script.scenario_name&&(t.storage=void 0),void 0===t.storage?(s(t),0===e.almight.script.line&&(this.almight.script.line=-1),void 0!==t.line&&(this.almight.script.line=t.line),1):(this.almight.script.load(t.storage).then(function(){s(t),void 0!==t.line&&(e.almight.script.line=t.line),setTimeout(function(){e.almight.script.dequeue()},0)},function(t,e){Almight.error("[jump] シナリオファイルのロードに失敗しました: "+e)}),2)},backlay:function(t){return void 0!==t.layer?this.stage.layerCopyTo(this.stage.getLayerPageFromParams(t,"fore"),this.stage.getLayerPageFromParams(t,"back"),"back"):this.stage.layerCopy("back"),1},forelay:function(t){return void 0!==t.layer?this.stage.layerCopyTo(this.stage.getLayerPageFromParams(t,"back"),this.stage.getLayerPageFromParams(t,"fore"),"fore"):this.stage.layerCopy("fore"),almight.buttonsEvent(),1},copylay:function(t){var e=void 0===t.srcpage?"fore":t.srcpage,i=void 0===t.destpage?"fore":t.destpage,s=this.stage.getLayerPageFromParams({layer:t.srclayer},e),a=this.stage.getLayerPageFromParams({layer:t.destlayer},i);if(s.type!==a.type)Almight.error("[copylay] srclayerとdestlayerのレイヤータイプが一致していないためコピー出来ません");else{var n=1;/^message[0-9]+$/.test(t.destlayer)?(n=Number(t.destlayer.replace("message","")),n+=1e3):"number"==typeof t.destlayer&&(n=t.destlayer,n+=10),this.stage.layerCopyTo(s,a,i,n)}return almight.buttonsEvent(),1},freeimage:function(t){var e=void 0===t.page?this.stage.currentPage:t.page;if("all"===t.all&&this.stage[e].base.freeImage(),"layer"===t.all||"all"===t.all||t.all===!0)for(var i=0;this.stage[e].layers.length>i;i++)almight.stage[e].layers[i].freeImage();else this.stage.getLayerFromParams(t).freeImage();return 1},image:function(t){var e=this;return void 0!==t.storage&&(t.storage=Almight.Util.getPath(t.storage)),this.almight.debug&&console.time(t.storage+"の読み込み時間"),this.stage.getLayerFromParams(t).loadImages(t,!0).then(function(){e.almight.debug&&console.timeEnd(t.storage+"の読み込み時間"),e.almight.script.dequeue()},function(t){Almight.error(t)}),2},fillrect:function(t){return this.stage.getLayerFromParams(t).fillRect(t),1},pimage:function(t){var e=this;return void 0!==t.storage&&(t.storage=Almight.Util.getPath(t.storage)),this.almight.debug&&console.time(t.storage+"の読み込み時間"),this.stage.getLayerFromParams(t).loadPartialImage(t).then(function(){e.almight.debug&&console.timeEnd(t.storage+"の読み込み時間"),e.almight.script.dequeue()},function(t){Almight.error(t)}),2},layopt:function(t){return this.stage.getLayerFromParams(t).setOptions(t),1},laycount:function(t){return"number"==typeof t.layers&&this.almight.allocateLayers(t.layers),"number"==typeof t.messages&&this.almight.allocateMessageLayers(t.messages),1},trans:function(t){var e=this;return this.stage.skipping||10>=t.time?(this.stage.layerCopy("fore"),1):(void 0!==t.rule&&(t.rule=Almight.Util.getPath(t.rule)),this.almight.stage.beginTransition(t).then(function(){e.almight.script.dequeue()},function(t){throw t}),2)},wt:function(t){var e=this,i="boolean"==typeof t.canskip?t.canskip:!0;return this.almight.stage.transitioning?(this.almight.stage.trans.dfwt.then(function(){$(Almight).off(".transskip"),e.almight.script.dequeue()},function(t){throw t}),i&&$(Almight).off(".transskip").one("stageclick.transskip",function(){e.almight.stage.onTransitionCompleted()}),2):1},stoptrans:function(){return this.almight.stage.onTransitionCompleted(),1},move:function(t){var e="linear",i=this.stage.getLayerFromParams(t);"number"==typeof t.accel&&(1===t.accel&&(e="easeInSine"),2===t.accel&&(e="easeInQuad"),3===t.accel&&(e="easeInQuart"),4===t.accel&&(e="easeInQuint"),t.accel>=5&&(e="easeInExpo"),-1===t.accel&&(e="easeOutSine"),-2===t.accel&&(e="easeOutQuad"),-3===t.accel&&(e="easeOutQuart"),-4===t.accel&&(e="easeOutQuint"),-5>=t.accel&&(e="easeOutExpo"));var s,a=/\(\s*([\-0-9]+)\s*,\s*([\-0-9]+)\s*,\s*([\-0-9]+)\s*\)/,n=$.trim(t.path),o=[];if(a.test(n))for(;a.test(n);)s=n.match(a),4===s.length?(o.push([parseInt(s[1],10),parseInt(s[2],10),s[3]/255]),n=n.replace(s[0],"")):Almight.error("[move] path属性の値が正しい形式になっていません");else Almight.error("[move] path属性の値が正しい形式になっていません");for(var r=0;o.length>r;r++)i.animateQueue({x:o[r][0],y:o[r][1],opacity:o[r][2],easing:e,duration:t.time});return i.animateStart(),1},anim:function(t){return this.stage.getLayerFromParams(t).animateQueue(t),1},animstart:function(t){return this.stage.getLayerFromParams(t).animateStart(),1},wm:function(t){if(void 0===t.layer&&Almight.error("[wm] layer属性は必須です"),0===$(this.stage.getLayerFromParams(t).element).queue("fx").length)return 1;var e=this,i=void 0===t.canskip?!1:t.canskip;return $(this.stage.getLayerFromParams(t).element).one("animateEnd",function(){$(Almight).off(".animskip"),e.almight.script.dequeue()}),i&&$(Almight).off(".animskip").one("stageclick.animskip",function(){$(e.stage.getLayerFromParams(t).element).transitionStop(!0,!0)}),2},bgmopt:function(t){return"number"==typeof t.volume&&(t.volume/=100),"number"==typeof t.gvolume&&(t.gvolume/=100),this.almight.bgm.setOptions(t),1},playbgm:function(t){var e=this;return void 0!==t.storage&&(t.storage=Almight.Util.getPath(t.storage)),this.almight.bgm.setPlay(t).then(function(){e.almight.script.dequeue()},function(t){Almight.error(t)}),2},wl:function(t){var e=void 0===t.canskip?!1:t.canskip;return this.almight.bgm.playing?this.almight.bgm.loop?1:($(this.almight.bgm).one("ended",function(){$(Almight).off(".wlskip"),self.almight.script.dequeue()}),e&&$(Almight).off(".wlskip").one("stageclick.wlskip",function(){self.almight.bgm.setStop(),$(self.almight.bgm).triggerHandler("ended")}),2):1},stopbgm:function(){return this.almight.bgm.setStop(),1},fadeinbgm:function(t){"number"!=typeof t.time&&Almight.error("[fadeinbgm] time属性はNumberで必須です");var e=this;return void 0!==t.storage&&(t.storage=Almight.Util.getPath(t.storage)),this.almight.bgm.setPlay(t).then(function(){e.almight.bgm.fadeTo(0,null,t.time).done(function(){$(e.almight.bgm).off("fadeBgmSkip").triggerHandler("fadeBgmEnd")}),e.almight.script.dequeue()},function(t){Almight.error(t)}),$(this.almight.bgm).one("fadeBgmSkip",function(){e.almight.bgm.fadeSkip()}),2},fadeoutbgm:function(t){var e=this;return this.almight.bgm.fadeTo(null,0,t.time).done(function(){e.almight.bgm.setStop(),$(e.almight.bgm).off("fadeBgmSkip").triggerHandler("fadeBgmEnd")}),$(this.almight.bgm).one("fadeBgmSkip",function(){e.almight.bgm.fadeSkip()}),1},fadebgm:function(t){(t.volume>100||0>t.volume)&&Almight.error("[fadebgm] volume属性は0〜100で必須です"),"number"!=typeof t.time&&Almight.error("[fadebgm] time属性はNumberで必須です");var e=t.volume/100;return this.almight.bgm.fadeTo(null,e,t.time).done(function(){self.almight.bgm.setVolume(e),$(self.almight.bgm).off("fadeBgmSkip").triggerHandler("fadeBgmEnd")}),$(this.almight.bgm).one("fadeBgmSkip",function(){self.almight.bgm.fadeSkip()}),1},wb:function(t){var e=this,i="boolean"==typeof t.canskip?t.canskip:!1;return this.almight.bgm.fading?($(this.almight.bgm).one("fadeBgmEnd",function(){$(Almight).off(".wbskip"),e.almight.script.dequeue()}),i&&$(Almight).off(".wbskip").one("stageclick.wbskip",function(){e.almight.bgm.fadeSkip(),$(e.almight.bgm).triggerHandler("fadeBgmSkip")}),2):1},seopt:function(t){var e="number"==typeof t.buf?t.buf:0;return"number"==typeof t.volume&&(t.volume/=100),"number"==typeof t.gvolume&&(t.gvolume/=100),this.almight.se[e].setOptions(t),1},playse:function(t){var e=this,i="number"==typeof t.buf?t.buf:0;return void 0!==t.storage&&(t.storage=Almight.Util.getPath(t.storage)),this.almight.se[i].setPlay(t).then(function(){e.almight.script.dequeue()},function(t){Almight.error(t)}),2},ws:function(t){var e=void 0===t.canskip?!1:t.canskip,i="number"==typeof t.buf?t.buf:0;return this.almight.se[i].playing?this.almight.se[i].loop?1:($(this.almight.se[i]).one("ended",function(){$(Almight).off(".wsskip"),self.almight.script.dequeue()}),e&&$(Almight).off(".wsskip").one("stageclick.wsskip",function(){self.almight.se[i].setStop(),$(self.almight.se[i]).triggerHandler("ended")}),2):1},stopse:function(t){var e="number"==typeof t.buf?t.buf:0;if("all"===t.buf||"all"===t.all||t.all===!0)for(var i=0;almight.config.sound.seCount>i;i++)this.almight.se[i].setStop();else this.almight.se[e].setStop();return 1},fadeinse:function(t){"number"!=typeof t.time&&Almight.error("[fadeinse] time属性はNumberで必須です");var e=this,i="number"==typeof t.buf?t.buf:0;return void 0!==t.storage&&(t.storage=Almight.Util.getPath(t.storage)),this.almight.se[i].setPlay(t).then(function(){e.almight.se[i].fadeTo(0,null,t.time).done(function(){$(e.almight.se[i]).off("fadeSeSkip").triggerHandler("fadeSeEnd")}),e.almight.script.dequeue()},function(t){Almight.error(t)}),$(this.almight.se[i]).one("fadeSeSkip",function(){e.almight.se[i].fadeSkip()}),2},fadeoutse:function(t){var e=this,i="number"==typeof t.buf?t.buf:0;return this.almight.se[i].fadeTo(null,0,t.time).done(function(){e.almight.se[i].setStop(),$(e.almight.se[i]).off("fadeSeSkip").triggerHandler("fadeSeEnd")}),$(this.almight.se[i]).one("fadeSeSkip",function(){e.almight.se[i].fadeSkip()}),1},fadese:function(t){(t.volume>100||0>t.volume)&&Almight.error("[fadese] volume属性は0〜100で必須です"),"number"!=typeof t.time&&Almight.error("[fadese] time属性はNumberで必須です");var e="number"==typeof t.buf?t.buf:0,i=t.volume/100;return this.almight.se[e].fadeTo(null,i,t.time).done(function(){self.almight.se[e].setVolume(i),$(self.almight.se[e]).off("fadeSeSkip").triggerHandler("fadeSeEnd")}),$(this.almight.se[e]).one("fadeSeSkip",function(){self.almight.se[e].fadeSkip()}),1},wf:function(t){var e=this,i="boolean"==typeof t.canskip?t.canskip:!1,s="number"==typeof t.buf?t.buf:0;return this.almight.se[s].fading?($(this.almight.se[s]).one("fadeSeEnd",function(){$(Almight).off(".wfskip"),e.almight.script.dequeue()}),i&&$(Almight).off(".wfskip").one("stageclick.wfskip",function(){e.almight.se[s].fadeSkip(),$(e.almight.se[s]).triggerHandler("ended")}),2):1},"if":function(t){void 0===t.exp&&Almight.error("[if] exp属性は必須です");var e;return e=this.almight.script.ifstate===!0&&-1!==this.almight.script.ifstack.indexOf(!1)?!1:Almight.exec(t.exp)?!0:!1,this.almight.script.ifstack.unshift(e),this.almight.script.ifstate=!0,1},"else":function(){return this.almight.script.ifstack[0]=this.almight.script.ifstate===!0&&-1!==this.almight.script.ifstack.indexOf(!1)?!this.almight.script.ifstack[0]:null,1},elsif:function(t){void 0===t.exp&&Almight.error("[elsif] exp属性は必須です");var e;return this.almight.script.ifstate===!0&&-1!==this.almight.script.ifstack.indexOf(!1)?(e=Almight.exec(t.exp)?!0:!1,this.almight.script.ifstack[0]=e):this.almight.script.ifstack[0]=null,1},endif:function(){return this.almight.script.ifstack.shift(),0===this.almight.script.ifstack.length&&(this.almight.script.ifstate=!1),1},ignore:function(t){void 0===t.exp&&Almight.error("[ignore] exp属性は必須です");var e;return e=Almight.exec(t.exp)?!0:!1,this.almight.script.ifstack.unshift(!e),this.almight.script.ifstate=!0,1},endignore:function(){return this.almight.script.ifstack.shift(),0===this.almight.script.ifstack.length&&(this.almight.script.ifstate=!1),1},eval:function(t){return Almight.exec(t.exp,!0),1},iscript:function(t){return Almight.exec(t.exp,!0),1},emb:function(t){return void 0===t.exp&&Almight.error("[emb] exp属性は必須です"),t.text=Almight.exec(t.exp),t.text=void 0===t.text||null===t.text?"":t.text+"",this._text_(t)},clearvar:function(){return window.f={},1},trace:function(t){return console.warn("[trace] : "+Almight.exec(t.exp)),1},"debugger":function(){return 1}},Almight.Tag.prototype.img=Almight.Tag.prototype.image,Almight.Tag.prototype.elseif=Almight.Tag.prototype.elsif}(),function(){"use strict";Almight.Script=function(t){this.scenario={},this.label={},this.scenario_name="",this.line=0,this.stack=[],this.callstack=[],this.macro={},this.macrostack=[],this.ifstack=[],this.ifstate=!1,this.almight=t,this.tag=this.almight.tag},Almight.Script.prototype={command:function(t,e){t=this.parser(t);var i=this.exec(t[0]);return 1===i&&e!==!1&&this.dequeue(),i},queue:function(t){this.stack.push(t)},dequeue:function(){if(void 0===this.scenario[this.scenario_name])throw"この名前のシナリオデータはありません";$(Almight).triggerHandler("exec");var t=0;this.almight.userwait=!1,0!==this.stack.length?t=this.exec(this.stack.shift()):this.line<this.scenario[this.scenario_name].length?(0>this.line&&(this.line=0),t=this.exec(this.scenario[this.scenario_name][this.line]),this.line++):t=0,2===t||(1===t?this.dequeue():0===t&&this.userWait())},userWait:function(){this.almight.userwait=!0,$(Almight).triggerHandler("userwait")},exec:function(t){var e,i=$.extend(!0,{},t);if(this.ifstate===!0&&(-1!==this.ifstack.indexOf(!1)||-1!==this.ifstack.indexOf(null)))return"if"===i._type_||"else"===i._type_||"elsif"===i._type_||"endif"===i._type_||"endignore"===i._type_?this.tag[i._type_](i):1;if(-1!==$.inArray(i._type_,almight.config.ignoretag))return 1===this.almight.debug&&console.log("ignoretag ["+i._type_+"]",i),1;if("function"==typeof this.tag[i._type_])return i=this.replace(i),1===this.almight.debug&&"_"!==i._type_.charAt(0)&&"trace"!==i._type_&&console.log("["+i._type_+"]",i),this.tag[i._type_](i);if("object"==typeof this.macro[i._type_]){if(i=this.replace(i),"_void_"===i._type_)return 1;for(this.macrostack.push({attr:i,name:i._type_}),window.mp=i,this.almight.debug&&(this.almight.debug>=2?console.group("["+i._type_+"]"):console.groupCollapsed("["+i._type_+"]"),console.log("["+i._type_+"]",i)),this.stack.unshift({_type_:"_endmacro_",name:i._type_}),e=this.macro[i._type_].length-1;e>=0;e--)this.stack.unshift(this.macro[i._type_][e]);return 1}return console.error("tagNotFound",i._type_),1},replace:function(t){t._all_===!0&&(t=$.extend(this.macrostack[0].attr,t));var e="";void 0!==t.cond&&(Almight.exec(t.cond)||(t._origin_=t._type_,t._type_="_void_"));for(var i in t){if("exp"!==i&&(/^\%/.test(t[i])&&(t["%"+i]=t[i],e=(t[i]+"").replace(/^\%/,"&mp."),t[i]=e),/\|/.test(t[i]))){e=t[i],t["_"+i]=e,e=e.split("|"),"&"===e[0].charAt(0)&&(e[0]=e[0].substring(1));try{e[0]=Almight.exec(e[0])}catch(s){e[0]=null}void 0===e[0]||null===e[0]?(e=e[1],/^[\-\+]?[0-9\.]+$/.test(e)&&!/^0[0-9]+./.test(e)?e=Number(e):"true"===e?e=!0:"false"===e&&(e=!1)):e=e[0],t[i]=e}/^\&/.test(t[i])&&(t["&"+i]=t[i],e=(t[i]+"").replace(/^\&/,""),t[i]=Almight.exec(e))}return"_all_"in t&&delete t._all_,t},parser:function(t){var e=[],i=[],s=[];for(t=t.replace(/\/\*([\s\S]*?)\*\//gi,""),t=t.replace(/(\/*|;*)[^\s\s](@iscript|\[iscript)/gi,"//"),t=t.replace(/(\/*|;*)[^\s\s](@endscript|\[endscript)/gi,"//");/(@iscript|\[iscript).*$([\s\S]+?)(@endscript|\[endscript).*$/m.test(t);)i.push(/(@iscript|\[iscript).*$([\s\S]+?)(@endscript|\[endscript).*$/m.exec(t)[2]),t=t.replace(/(@iscript|\[iscript).*$[\s\S]+?(@endscript|\[endscript).*$/m,"@_script_ exp="+(i.length-1));for(;/(@html|\[html).*$([\s\S]+?)(@endhtml|\[endhtml).*$/m.test(t);)s.push(/(@html|\[html).*$([\s\S]+?)(@endhtml|\[endhtml).*$/m.exec(t)[2]),t=t.replace(/(@html|\[html).*$[\s\S]+?(@endhtml|\[endhtml).*$/m,"@_html_ exp="+(s.length-1));
t=t.split(/[\n\r]/g);for(var a=0;t.length>a;a++){if(t[a]=t[a].replace(/\\$/,""),t[a]=t[a].replace(/^[ \t\r\n]+|[ \t\r\n]+$/g,""),/^\s*;|^\s*\/\//.test(t[a])&&(t[a]=""),/^\s*@/.test(t[a])&&(t[a]="["+$.trim(t[a].replace(/^\s*@/,""))+"]"),/^\s*\*/.test(t[a])){var n=$.trim(t[a]).substring(1).split("|"),o=n[0];n=n.length>1?n[1]:null,""===o||null===n&&""===n||e.push({_type_:"_label_",id:o,name:n}),t[a]=""}var r=!0;do{var l=t[a].search(/\[/),h={};if(-1!==l){0!==l&&(e.push({_type_:"_text_",text:t[a].substring(0,l)}),t[a]=t[a].substring(l));var g=/^\[ *(.*?)[ \]]/.exec(t[a])[1];t[a]=t[a].replace(/^\[(.*?)([ \]])/,function(t,e,i){return"]"===i?"]":""}),h._type_=g.toLowerCase();for(var c=!0,m="";c;){/^\*/.test(t[a])&&(t[a]="_all_=true "+t[a].replace(/^\*/,""));var u=/^([_a-zA-Z0-9一-龠ぁ-んァ-ヴー]+)/.exec(t[a]);if(null===u){t[a]=t[a].replace(/(.*?)\]/,"");break}u=u[1],t[a]=t[a].replace(/^[_a-zA-Z0-9一-龠ぁ-んァ-ヴー]+ *= */,""),m=/^"(((\\")|[^"])*?)"/.exec(t[a]),null===m?(m=/^(.*?)[ \]]/.exec(t[a]),t[a]=t[a].replace(m[1],"").replace(/^ */,"")):t[a]=t[a].replace(/^"(.*?)" */,""),m=m[1],h[u]=m,"]"===t[a].charAt(0)&&(t[a]=t[a].substring(1),c=!1)}e.push(h)}else""!==t[a]&&"\\"!==t[a]&&e.push({_type_:"_text_",text:t[a]}),r=!1;""===t[a]&&(r=!1)}while(r)}for(a=0;e.length>a;a++)$.each(e[a],function(t,i){"_type_"!==t&&"text"!==t&&"exp"!==t&&(/^[\-\+]?[0-9\.]+$/.test(i)&&!/^0[0-9]+./.test(i)?e[a][t]=Number(i):"true"===i?e[a][t]=!0:"false"===i&&(e[a][t]=!1))}),"_script_"===e[a]._type_&&(e[a].exp=i[e[a].exp],e[a]._type_="iscript"),"_html_"===e[a]._type_&&(e[a].exp=s[e[a].exp],e[a]._type_="html");return e},parseLabel:function(t){var e,i={};for(e=0;t.length>e;e++)"_label_"===t[e]._type_&&(i[t[e].id+""]={line:e,name:t[e].name});return i},load:function(t){var e=$.Deferred();if(this.scenario_name=t,this.line=0,this.scenario_name in this.scenario){var i=this;return setTimeout(function(){return i.almight.debug&&console.log("============================\nシナリオをロード: "+i.scenario_name+" (cache)\n============================"),i=null,e.resolve()},0),e.promise()}var i=this;return $.ajax({url:t,type:"GET",dataType:"text",cache:!this.almight.debug}).done(function(t){i.almight.debug&&console.time("シナリオ解析時間"),i.scenario[i.scenario_name]=i.parser(t),i.label[i.scenario_name]=i.parseLabel(i.scenario[i.scenario_name]),i.almight.debug&&(console.log("============================\nシナリオをロード: "+i.scenario_name+"\n============================"),console.timeEnd("シナリオ解析時間")),e.resolve()}).fail(function(t,i){e.reject(t,i)}),e.promise()},dump:function(){var t=$.extend(!0,{},{scenario_name:this.scenario_name,line:this.line,stack:this.stack,callstack:this.callstack,macrostack:this.macrostack,ifstack:this.ifstack,ifstate:this.ifstate});return t},restore:function(t){var e=this;this.load(t.scenario_name).done(function(){e.line=t.line,e.stack=t.stack,e.callstack=t.callstack,e.macrostack=t.macrostack,e.ifstack=t.ifstack,e.ifstate=t.ifstate})}}}(),function(){"use strict";Almight.Core=function(){this._slot=[],this._back={base:null,layers:[],messages:[]},this._fore={base:null,layers:[],messages:[]},this.bgm=null,this.se=[],this.plugin={},this.stage=null,this.userwait=!1,this.debug=0,this.config={fx:!0,linkHoverColor:"rgba(200, 200, 0, 0.4)",chspeed:{nowait:0,nowaiting:!1,actual:"normal",tmp:"normal"}},this.initialize.apply(this,arguments)},Almight.Core.prototype={initialize:function(t){this.init=$.Deferred();var e=this,i=0;for($.extend(!0,this.config,t),this.debug=this.config.debug,window.f={},window.sf={},window.tf={},window.mp={},i=0;this.config.bookmarkCount>i;i++)if(this._slot[i]=this.read("save"+i),"string"==typeof this._slot[i]){var s=Base64.decode(this._slot[i]);s=decodeURIComponent(s),this._slot[i]=JSON.parse(s)}for(this.systemLoad(),document.title=this.config.title,Almight.lang=this.config.language,Almight.resourcePath=this.config.resourcePath,0>=this.config.messages.animateTime?this.config.messages.animateMobile=!1:Almight.Platform.mobile||(this.config.messages.animateMobile=!0),this.stage=new Almight.Stage(this.config.container,this.config.width,this.config.height),this.allocateBaseLayer(),this.allocateLayers(this.config.layerCount),this.allocateMessageLayers(this.config.messageLayerCount),this.stage.setCurrentMessageLayer({page:"fore"}),this.config.initialMessageLayerVisible&&(this.stage.back.messages[0].setVisible(!0),this.stage.fore.messages[0].setVisible(!0)),this.bgm=new Almight.Sound("bgm"),i=0;this.config.sound.seCount>i;i++)this.se[i]=new Almight.Sound("se"+i);if(this.tag=new Almight.Tag(this),this.script=new Almight.Script(this),"function"==typeof require){var a=require("nw.gui");a.Window.get().on("close",function(){e.systemSave(),this.close(!0)})}$(window).on("beforeunload.systemSave",function(){e.systemSave()}),$(window).on("resize.resizeStage",function(){e.stage.resizeStage()}).trigger("resize");var n=[],o=$.Deferred();for(i=0;this.config.plugin.length>i;i++)(function(t){$(Almight).queue("loadplugin",function(){e.plugin[e.config.plugin[t]]=new Almight.Plugin(e.config.plugin[t]),e.plugin[e.config.plugin[t]].done(function(){$(Almight).dequeue("loadplugin")}).fail(function(t){o.reject(t)})})})(i);return $(Almight).queue("loadplugin",function(){o.resolve()}),n.push(o),this.config.filepath&&n.push(function(){return $.ajax({url:Almight.resourcePath+"6a2a431fe8b621037ea949531c28551d",type:"GET",dataType:"text"}).done(function(t){"{"!==t.charAt(0)&&(t=Base64.decode(t)),Almight.filePath=JSON.parse(t)})}()),this.path=function(){return Almight.Util.getPath.apply(this,arguments)},$.when.apply($,n).done(function(){e.init.resolve()}).fail(function(t){e.init.reject(t)}),$(Almight).dequeue("loadplugin"),setInterval(function(){e.systemSave()},1e4),this.init.promise()},exit:function(){this.systemSave(),Almight.Platform.viewer?Titanium.App.fireEvent("setExit"):(window.close(),location.href="about:blank")},allocateBaseLayer:function(){this._fore.base=new Almight.GraphicLayer(this.config.width,this.config.height,2),this._fore.base.setVisible(!0),this._fore.base.type="base",this.stage.add(this._fore.base,"fore","base"),this._back.base=new Almight.GraphicLayer(this.config.width,this.config.height,1),this._back.base.setVisible(!0),this._back.base.type="base",this.stage.add(this._back.base,"back","base")},allocateLayers:function(t){var e=0;if(this._fore.layers.length===t)return!1;if(this._fore.layers.length>t)for(e=this._fore.layers.length-1;e>=t;e--)this.stage.remove("fore",e),this._fore.layers[e]=null,this._fore.layers.splice(e,1),this.stage.remove("back",e),this._back.layers[e]=null,this._back.layers.splice(e,1);else for(e=this._fore.layers.length;t>e;e++)this._fore.layers[e]=new Almight.GraphicLayer(this.config.width,this.config.height,10+e+1),this.stage.add(this._fore.layers[e],"fore",e),this._back.layers[e]=new Almight.GraphicLayer(this.config.width,this.config.height,10+e),this.stage.add(this._back.layers[e],"back",e)},allocateMessageLayers:function(t){var e=0;if(this._fore.messages.length===t)return!1;if(this._fore.messages.length>t)for(e=this._fore.messages.length-1;e>=t;e--)this.stage.remove("fore","message"+e),this._fore.messages[e]=null,this._fore.messages.splice(e,1),this.stage.remove("back","message"+e),this._back.messages[e]=null,this._back.messages.splice(e,1);else for(e=this._fore.messages.length;t>e;e++)this._fore.messages[e]=new Almight.MessageLayer(this.config.width,this.config.height,100+e+1,this.config.messages),this.stage.add(this._fore.messages[e],"fore","message"+e),this._back.messages[e]=new Almight.MessageLayer(this.config.width,this.config.height,100+e,this.config.messages),this.stage.add(this._back.messages[e],"back","message"+e)},buttonsEvent:function(){$(".almight-link, .almight-button, .almight-choices").off("mouseover mouseout mousedown mouseup click tap");var t=this;$(".almight-link, .almight-button, .almight-choices").each(function(){$(this).on("mouseover",function(){if($(this).hasClass("almight-button")&&$(this).css("background-position","-"+2*$(this).attr("data-width")+"px 0"),$(this).hasClass("almight-link")&&$(this).css("background-color",t.config.linkHoverColor),void 0!==$(this).attr("data-enterse")){var e=void 0===$(this).attr("data-entersebuf")?0:parseInt($(this).attr("data-entersebuf"),10);t.se[e].setPlay({storage:$(this).attr("data-enterse"),loop:!1})}return void 0!==$(this).attr("data-onenter")&&$.globalEval($(this).attr("data-onenter")),!1}).on("mouseout",function(){if($(this).hasClass("almight-button")&&$(this).css("background-position","0 0"),$(this).hasClass("almight-link")&&$(this).css("background-color",""),void 0!==$(this).attr("data-leavese")){var e=void 0===$(this).attr("data-leavesebuf")?0:parseInt($(this).attr("data-leavesebuf"),10);t.se[e].setPlay({storage:$(this).attr("data-leavese"),loop:!1})}return void 0!==$(this).attr("data-onleave")&&$.globalEval($(this).attr("data-onleave")),!1}).on("mousedown",function(){if($(this).hasClass("almight-button")&&$(this).css("background-position","-"+$(this).attr("data-width")+"px 0"),void 0!==$(this).attr("data-clickse")){var e=void 0===$(this).attr("data-clicksebuf")?0:parseInt($(this).attr("data-clicksebuf"),10);t.se[e].setPlay({storage:$(this).attr("data-clickse"),loop:!1})}return!1}).on("mouseup",function(){return $(this).css("background-position","0 0"),!1}).on("touchstart",function(){if($(this).hasClass("almight-button")&&$(this).css("background-position","-"+$(this).attr("data-width")+"px 0"),$(this).hasClass("almight-link")&&$(this).css("background-color",t.config.linkHoverColor),void 0!==$(this).attr("data-clickse")){var e=void 0===$(this).attr("data-clicksebuf")?0:parseInt($(this).attr("data-clicksebuf"),10);t.se[e].setPlay({storage:$(this).attr("data-clickse"),loop:!1})}}).on("touchend",function(){$(this).hasClass("almight-button")&&$(this).css("background-position","0 0"),$(this).hasClass("almight-link")&&$(this).css("background-color","")}).on("click tap",function(){void 0!==$(this).attr("data-exp")&&$.globalEval($(this).attr("data-exp")),$(this).hasClass("almight-button")&&$(this).css("background-position","0 0"),$(this).hasClass("almight-link")&&$(this).css("background-color","");var e=$(this).attr("data-storage"),i=$(this).attr("data-target");if((void 0!==e||void 0!==i)&&$(".almight-link, .almight-button, .almight-choices").off("mouseover mouseout mousedown mouseup click"),$(this).hasClass("ui-choices"))return $("#almight-choices-window").fadeOut("fast",function(){if($("#almight-choices-window").remove(),void 0!==e||void 0!==i){var s=t.tag.jump({storage:e,target:i});1===s&&t.script.dequeue()}else t.script.dequeue()}),!1;if(void 0!==e||void 0!==i){var s=t.tag.jump({storage:e,target:i});1===s&&t.script.dequeue()}return!1})})},getBookmarkDate:function(t){return"object"==typeof this._slot[t]?this._slot[t].time:""},getBookmarkName:function(t){return"object"==typeof this._slot[t]?this._slot[t].name:""},getBookmarkScreenshot:function(t){return"object"==typeof this._slot[t]?this._slot[t].screenshot:""},getBookmark:function(t){return"object"==typeof this._slot[t]?this._slot[t]:null},getBookmarkExist:function(t){return"object"==typeof this._slot[t]?!0:!1},saveBookmark:function(t){if(this.systemSave(),"number"!=typeof t||!this.userwait||t>this.config.bookmarkCount)return!1;var e=$.Deferred(),i=this,s=$(".almight-message-layer").text().substring(0,30),a=0,n=new Date,o=n.getFullYear()+"/"+(n.getMonth()+1)+"/"+n.getDate()+" "+n.getHours()+":"+(n.getMinutes()>=10?n.getMinutes():"0"+n.getMinutes()),r={f:$.extend(!0,{},window.f),name:s,time:o,screenshot:"",core:{clickWaiting:this.stage.clickWaiting,historyOutput:this.stage.historyOutput,historyEnabled:this.stage.historyEnabled,config:this.config},script:almight.script.dump(),base:{fore:null,back:null},layers:{fore:[],back:[]},messages:{currentNum:this.stage.currentNum,currentPage:this.stage.currentPage,fore:[],back:[]},bgm:{playing:this.bgm.playing,volume:this.bgm.volume,loop:this.bgm.loop,src:this.bgm.src},se:[]};for(r.base.fore=this.stage.fore.base.dump(),r.base.back=this.stage.back.base.dump(),a=0;this.stage.fore.layers.length>a;a++)r.layers.fore[a]=this.stage.fore.layers[a].dump(),r.layers.back[a]=this.stage.back.layers[a].dump();for(a=0;this.stage.fore.messages.length>a;a++)r.messages.fore[a]=this.stage.fore.messages[a].dump(),r.messages.back[a]=this.stage.back.messages[a].dump();for(a=0;this.se.length>a;a++)r.se[a]={playing:this.se[a].playing,volume:this.se[a].volume,loop:this.se[a].loop,src:this.se[a].src};return r.stageWindow=$("#almight-choices-window").outerHTML(),html2canvas(this.stage.element,{background:"#000",width:2*this.stage.width,height:2*this.stage.height,onrendered:function(t){var s=i.config.thumbMaxWidth,a=~~(i.config.thumbMaxWidth/i.stage.width*i.stage.height),n=$("<canvas/>").attr({width:s,height:a})[0],o=n.getContext("2d");o.fillStyle="#000000",o.fillRect(0,0,s,a),o.drawImage(t,0,0,s,a),e.resolve(n)}}),e.done(function(e){r.screenshot=e.toDataURL(),i._slot[t]=r,r=JSON.stringify(r),r=encodeURIComponent(r),r=Base64.encode(r),i.write("save"+t,r)}),e.promise()},loadBookmark:function(t){if(!this.userwait||t>this.config.bookmarkCount)return!1;var e=$.extend(!0,{},this._slot[t]);if(void 0===e||0===Object.keys(e).length)return!1;var i=0,s=this;$(Almight).triggerHandler("exec"),$(this.stage.container).transition({opacity:0,duration:500,complete:function(){for(s.bgm.setStop(),i=0;s.se.length>i;i++)s.se[i].setStop();for($(s.stage.element).children("div").not(".almight-layer, .almight-message-layer").hide(),$("#almight-choices-window").remove(),$(Almight).off(".clickwait"),s.stage.clickWaiting="",window.f=$.extend(!0,{},e.f),s.config=$.extend(!0,{},e.core.config),s.stage.historyOutput=e.core.historyOutput,s.stage.historyEnabled=e.core.historyEnabled,s.allocateLayers(0),s.allocateMessageLayers(0),s.allocateLayers(e.layers.fore.length),s.allocateMessageLayers(e.messages.fore.length),s.stage.fore.base.restore(e.base.fore),s.stage.back.base.restore(e.base.back),i=0;e.layers.fore.length>i;i++)s.stage.fore.layers[i].restore(e.layers.fore[i]),s.stage.back.layers[i].restore(e.layers.back[i]);for(i=0;e.messages.fore.length>i;i++)s.stage.fore.messages[i].restore(e.messages.fore[i]),s.stage.back.messages[i].restore(e.messages.back[i]);for(s.stage.setCurrentMessageLayer({page:e.messages.currentPage,layer:"message"+e.messages.currentNum}),s.bgm.setVolume(e.bgm.volume),e.bgm.playing&&s.bgm.setPlay({storage:e.bgm.src,loop:e.bgm.loop}),i=0;e.se.length>i;i++)s.se[i].playing=e.se[i].playing,s.se[i].volume=e.se[i].volume,s.se[i].loop=e.se[i].loop,s.se[i].src=e.se[i].src,e.se[i].playing&&s.se[i].setPlay({storage:e.se[i].src,loop:e.se[i].loop});void 0!==e.stageWindow&&""!==e.stageWindow&&$(s.stage.element).append(e.stageWindow),""!==e.core.clickWaiting&&e.core.clickWaiting!==!1&&s.tag._clickwait_(e.core.clickWaiting),s.script.restore(e.script),s.buttonsEvent(),$(Almight).triggerHandler("loaded"),$(s.stage.container).transition({opacity:1,duration:500})}})},systemSave:function(){var t=JSON.stringify(window.sf);t=encodeURIComponent(t),t=Base64.encode(t),this.write("systemsave",t)},systemLoad:function(){var t=this.read("systemsave");void 0===t?window.sf={}:(t=Base64.decode(t),t=decodeURIComponent(t),t=JSON.parse(t),window.sf=$.extend({},t,!0))},write:function(t,e){localStorage[this.config.id+"_"+t]=e},read:function(t){var e=localStorage[this.config.id+"_"+t];return e}}}();